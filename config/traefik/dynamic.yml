# config/traefik/dynamic.yml
tls:
  certificates:
    - certFile: /etc/traefik/certs/n8n.agentshq.net+1.pem
      keyFile: /etc/traefik/certs/n8n.agentshq.net+1-key.pem
  stores:
    default:
      defaultCertificate:
        certFile: /etc/traefik/certs/n8n.agentshq.net+1.pem
        keyFile: /etc/traefik/certs/n8n.agentshq.net+1-key.pem

http:
  middlewares:
    security-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
        sslRedirect: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
    
    n8n-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
        sslRedirect: true
    
    compress:
      compress: {}
    
    mcp-sse:
      headers:
        customResponseHeaders:
          X-Accel-Buffering: "no"
          Cache-Control: "no-cache, no-store, must-revalidate"
          Connection: "keep-alive"
          Content-Type: "text/event-stream"
          Pragma: "no-cache"
          Expires: "0"
      buffering:
        maxRequestBodyBytes: 0
        memRequestBodyBytes: 0
        maxResponseBodyBytes: 0
        memResponseBodyBytes: 0
        retryExpression: "IsNetworkError() && Attempts() < 2"

  routers:
    # ADD THIS DEFAULT ROUTE:
    n8n-default:
      rule: "Host(`n8n.agentshq.net`) && PathPrefix(`/`)"
      service: n8n-webhook
      entryPoints:
        - websecure
      priority: 5  # Lower priority than specific routes
      middlewares:
        - n8n-headers
        - compress
      tls: {}
    
    # Your existing routes (keep these):
    n8n-mcp:
      rule: "Host(`n8n.agentshq.net`) && PathPrefix(`/mcp`)"
      service: n8n-mcp
      entryPoints:
        - websecure
      priority: 100  # Higher priority for specific paths
      middlewares:
        - mcp-sse
      tls: {}
    
    n8n-main:
      rule: "Host(`n8n.agentshq.net`)"
      service: n8n-webhook
      entryPoints:
        - websecure
      priority: 10
      middlewares:
        - n8n-headers
        - compress
      tls: {}

  services:
    n8n-webhook:
      loadBalancer:
        servers:
          - url: "http://n8n-webhook:5678"
        healthCheck:
          path: /healthz
          interval: 30s
          timeout: 10s
    
    n8n-mcp:
      loadBalancer:
        servers:
          - url: "http://n8n-mcp:5678"
        healthCheck:
          path: /healthz
          interval: 30s
          timeout: 10s
        passHostHeader: true
    
    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"
        healthCheck:
          path: /api/health
          interval: 30s
          timeout: 10s
